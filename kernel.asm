	[BITS 16]
	[ORG 0x8800]

%include "bios.h"
%include "sys_dos.h"
%include "reg.h"

ENTRYPOINT:
	MOV AX, CS
	MOV ES, AX
	MOV DS, AX
	MOV SS, AX
	MOV GS, AX
	MOV FS, AX

	MOV SI, PAYLOAD_STRING
	CALL PRINT
	
	MOV DX, DOSILE_STUB
	MOV AX, SYS_DOS
	CALL MAP_INTERRUPT
	
	MOV AX, 0x1234
	MOV BX, 0xBEEF
	MOV CX, 0xDEAD
	MOV DX, 0x5678
	INT SYS_DOS

	CLI
	HLT

DOSILE_STUB:
	PUSHA
	PUSH SS
	PUSH DS
	PUSH ES
	PUSH BP
	MOV BP, SP

	SHR AX, 8
	SHL AX, 1
	ADD AX, JMP_TAB
	MOV SI, AX
	MOV AX, [CS:SI]
	JMP AX
	
	MOV SP, BP
	POP BP
	POP ES
	POP DS
	POP SS
	POPA
	IRET

;Assumes ES:SI=string
PRINT:
	PUSHA
	MOV AH, PUTCHAR
PRINTLOOP:
	LODSB
	OR AL, AL
	JZ DONEPRINT
	INT TEXT_SERVICE
	JMP PRINTLOOP
DONEPRINT:
	POPA
	RET

MAP_INTERRUPT:
	PUSHA
	SHL AX, 2
	MOV BX, AX
	XOR AX, AX
	MOV ES, AX
	MOV [ES:BX], DX
	ADD BX, 2
	MOV [ES:BX], DS
	POPA
	RET

PRINT_NIBBLE:
	AND AL, 0x0F
	CMP AL, 10
	JGE IS_LETTER
	ADD AL, '0'
	JMP DONEPRINTNIBBLE
IS_LETTER:
	SUB AL, 0x0A
	ADD AL, 'A'
DONEPRINTNIBBLE:
	MOV AH, PUTCHAR
	INT TEXT_SERVICE
	RET

PRINT_BYTE:
	PUSHA
	MOV BX, AX
	SHR AX, 4
	CALL PRINT_NIBBLE
	MOV AX, BX
	CALL PRINT_NIBBLE
	POPA
	RET

PRINT_WORD:
	PUSHA
	MOV BX, AX
	MOV AL, BH
	CALL PRINT_BYTE
	MOV AL, BL
	CALL PRINT_BYTE
	POPA
	RET

REGISTER_DUMP:
	MOV AX, CS
	MOV ES, AX
	MOV SI, STR_AX
	CALL PRINT
	MOV AX, REGISTER_AX
	CALL PRINT_WORD
	MOV SI, STR_BX
	CALL PRINT
	MOV AX, REGISTER_BX
	CALL PRINT_WORD
	MOV SI, STR_CX
	CALL PRINT
	MOV AX, REGISTER_CX
	CALL PRINT_WORD
	MOV SI, STR_DX
	CALL PRINT
	MOV AX, REGISTER_DX
	CALL PRINT_WORD
	MOV SI, STR_SI
	CALL PRINT
	MOV AX, REGISTER_SI
	CALL PRINT_WORD
	MOV SI, STR_DI
	CALL PRINT
	MOV AX, REGISTER_DI
	CALL PRINT_WORD
	MOV SI, STR_BP
	CALL PRINT
	MOV AX, REGISTER_BP
	CALL PRINT_WORD
	MOV SI, STR_CR
	CALL PRINT
	RET

JMP_TAB:
	TIMES 256 DW BAD_INT_TRAP

BAD_INT_TRAP:
	MOV AX, CS
	MOV ES, AX
	MOV SI, TRAP_STRING
	CALL PRINT
	CALL REGISTER_DUMP
	CLI
	HLT

STR_AX:	DB "AX=", 0
STR_BX:	DB " BX=", 0
STR_CX:	DB " CX=", 0
STR_DX: DB " DX=", 0
STR_SI:	DB " SI=", 0
STR_DI:	DB " DI=", 0
STR_BP:	DB " BP=", 0

STR_CR:	DB 13, 10, 0

PAYLOAD_STRING: DB "Kernel successfully entered.", 13, 10, 0
INTERRUPT_TEST:	DB "Int 21h test call", 13, 10, 0
TRAP_STRING:	DB "Fatal: unknown interrupt option caught", 13, 10, 0
