	[BITS 16]
	[ORG 0x8800]

%include "bios.h"
%include "sys_dos.h"

ENTRYPOINT:
	MOV AX, CS
	MOV ES, AX
	MOV DS, AX
	MOV SS, AX
	MOV GS, AX
	MOV FS, AX

	MOV SI, PAYLOAD_STRING
	CALL PRINT
	
	MOV DX, DOSILE_STUB
	MOV AX, SYS_DOS
	CALL MAP_INTERRUPT
	
	MOV AX, 69
	INT SYS_DOS

	CLI
	HLT

DOSILE_STUB:
	PUSHA
	PUSH BP
	MOV BP, SP
	
	SHR AX, 8
	ADD AX, JMP_TAB
	MOV SI, AX
	MOV AX, [CS:SI]
	JMP AX

	MOV SP, BP
	POP BP
	POPA
	IRET

;Assumes ES:SI=string
PRINT:
	PUSHA
	MOV AH, PUTCHAR
PRINTLOOP:
	LODSB
	OR AL, AL
	JZ DONEPRINT
	INT TEXT_SERVICE
	JMP PRINTLOOP
DONEPRINT:
	POPA
	RET

MAP_INTERRUPT:
	PUSHA
	SHL AX, 2
	MOV BX, AX
	XOR AX, AX
	MOV ES, AX
	MOV [ES:BX], DX
	ADD BX, 2
	MOV [ES:BX], DS
	POPA
	RET

JMP_TAB:
	TIMES 256 DW BAD_INT_TRAP

BAD_INT_TRAP:
	MOV AX, CS
	MOV ES, AX
	MOV SI, TRAP_STRING
	CALL PRINT
	CLI
	HLT

PAYLOAD_STRING: DB "Kernel successfully entered.", 13, 10, 0
INTERRUPT_TEST:	DB "Int 21h test call", 13, 10, 0
TRAP_STRING:	DB "Fatal: unknown interrupt option caught", 13, 10, 0
